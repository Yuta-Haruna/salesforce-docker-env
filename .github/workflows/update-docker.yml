name: Always Build Salesforce Dev Container

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  schedule:
    - cron: '0 13 1 * *'  # æ¯æœˆ1æ—¥ 13:00(UTC)ã«å®Ÿè¡Œ â†’ æ—¥æœ¬æ™‚é–“ã§ã¯22æ™‚ or 23æ™‚å‰å¾Œã§ã¯ãªãã€4æ™‚ (ãƒ—ãƒ©ã‚¹9æ™‚é–“) ã«ãªã‚Šã¾ã™
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-docker:
    runs-on: ubuntu-latest
    permissions:
      packages: write   # GHCR ã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã®æ›¸ãè¾¼ã¿æ¨©é™

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 2. GHCR ãƒªãƒã‚¸ãƒˆãƒªåã®è¨­å®š
      - name: Set Repository Name
        run: |
          # GitHub ä¸Šã§ã®ã‚ªãƒ¼ãƒŠãƒ¼(ãƒ¦ãƒ¼ã‚¶ãƒ¼ or Org)åã‚’å°æ–‡å­—ã«å¤‰æ›
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME="ghcr.io/${REPO_OWNER_LOWER}/salesforce-cli"

          # ç’°å¢ƒå¤‰æ•° GITHUB_ENV ã«æ›¸ãè¾¼ã¿ã€å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

          echo "âœ… Using GHCR Repository: $REPO_NAME"

      # 3. GHCR ã«ãƒ­ã‚°ã‚¤ãƒ³ (Personal Access Token ã® GHCR_PAT ã‚’ä½¿ç”¨)
      - name: Login to GitHub Container Registry
        run: |
          # GitHub Container Registry (ghcr.io) ã¸ãƒ­ã‚°ã‚¤ãƒ³
          # ã“ã“ã§ã¯ GHCR_PAT (Personal Access Token) ã‚’ä½¿ç”¨
          # ${{ github.actor }} ã¯ GitHub Actions ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      # 4. æœ€æ–°ã® Salesforce CLI ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ pull (ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ä½¿ç”¨)
      - name: Pull latest Salesforce CLI image
        run: |
          # å…¬å¼ã®æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ Pull
          # Node.js å«ã‚€ â€œlatest-fullâ€ ãŒä¾¿åˆ©
          docker pull salesforce/cli:latest-full

      # 5. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ (å¸¸ã«å†ãƒ“ãƒ«ãƒ‰)
      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ env.REPO_NAME }}:latest"
          echo "ğŸ›  Building new image: $IMAGE_TAG"

          docker build -t "$IMAGE_TAG" .

      # 6. Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ push (latest ã®ã¿)ã€€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¿ã‚°ã¯è‡ªå‹•ã§å¤‰æ›´ã•ã‚Œã‚‹
      - name: Push Docker image
        run: |
          IMAGE_TAG="${{ env.REPO_NAME }}:latest"
          echo "ğŸ“¤ Pushing new image: $IMAGE_TAG"
          docker push "$IMAGE_TAG"

      # 7. Delete Old Tags (keep only latest)
      - name: Delete Old Tags
        run: |
          echo "ğŸ”„ Checking for existing tags in GHCR..."

          # GHCR ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾— (curlã§APIå‘¼ã³å‡ºã—)
          TAGS_RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GHCR_PAT }}" \
            "https://ghcr.io/v2/${{ env.REPO_NAME }}/tags/list")

          echo "ğŸ“ GHCR API Response: $TAGS_RESPONSE"

          # jq ã§ â€œtagsâ€ key ã‚’é…åˆ—ã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã—ã€ã‚¿ã‚°åã‚’å–å¾—
          EXISTING_TAGS=$(echo "$TAGS_RESPONSE" | jq -r '.tags[]? // empty')

          # ã‚¿ã‚°ãŒã¾ã£ãŸãå­˜åœ¨ã—ãªã„å ´åˆ (åˆå›å®Ÿè¡Œæ™‚ãªã©) ã¯ã‚¹ã‚­ãƒƒãƒ—
          if [[ -z "$EXISTING_TAGS" ]]; then
            echo "ğŸš€ No existing tags found in GHCR. This is the first run. Skipping deletion."
            exit 0
          fi

          # latest ä»¥å¤–ã®ã‚¿ã‚°ã‚’ã™ã¹ã¦å‰Šé™¤ã™ã‚‹
          for TAG in $EXISTING_TAGS; do
            if [ "$TAG" != "latest" ]; then
              echo "ğŸ—‘ Deleting old image tag: $TAG"
              curl -X DELETE \
                -H "Authorization: Bearer ${{ secrets.GHCR_PAT }}" \
                "https://ghcr.io/v2/${{ env.REPO_NAME }}/manifests/$TAG"
            fi
          done

      # 8. çµæœè¡¨ç¤º
      - name: Output Status
        run: |
          echo "â˜…â˜…â˜… Docker image built & pushed as 'latest' â˜…â˜…â˜…"
