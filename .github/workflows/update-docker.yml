name: Update Salesforce Dev Container

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  schedule:
    - cron: '0 13 1 * *'  # æ¯æœˆ1æ—¥ 13:00(UTC)ã«å®Ÿè¡Œ â†’ æ—¥æœ¬æ™‚é–“ã§ã¯22æ™‚ or 23æ™‚å‰å¾Œã§ã¯ãªãã€4æ™‚ (ãƒ—ãƒ©ã‚¹9æ™‚é–“) ã«ãªã‚Šã¾ã™
  workflow_dispatch:      # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-docker:
    runs-on: ubuntu-latest
    permissions:
      packages: write   # GHCR ã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ãŸã‚ã®æ›¸ãè¾¼ã¿æ¨©é™

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆDockerfileãªã©ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ï¼‰

      - name: Set Repository Name
        run: |
          # GitHub ä¸Šã§ã®ã‚ªãƒ¼ãƒŠãƒ¼(ãƒ¦ãƒ¼ã‚¶ãƒ¼ or Org)åã‚’å°æ–‡å­—ã«å¤‰æ›
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME="ghcr.io/${REPO_OWNER_LOWER}/salesforce-cli"

          # ç’°å¢ƒå¤‰æ•° GITHUB_ENV ã«æ›¸ãè¾¼ã¿ã€å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã§ä½¿ç”¨
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV

          echo "âœ… Using GHCR Repository: $REPO_NAME"

      - name: Login to GitHub Container Registry
        run: |
          # GitHub Container Registry (ghcr.io) ã¸ãƒ­ã‚°ã‚¤ãƒ³
          # ä»Šå›ã¯ GITHUB_TOKEN ã‚’ä½¿ç”¨
          # ${{ github.actor }} ã¯ GitHub Actions ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Pull latest Salesforce CLI image
        run: |
          # å…¬å¼ã®æœ€æ–°ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ Pull
          # Node.js å«ã‚€ â€œlatest-fullâ€ ãŒä¾¿åˆ©
          docker pull salesforce/cli:latest-full

      - name: Get Salesforce CLI Version
        id: get-cli-version
        run: |
          # pulled ã‚¤ãƒ¡ãƒ¼ã‚¸å†…ã® â€œsf --versionâ€ ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          CLI_VERSION_RAW=$(docker run --rm salesforce/cli:latest-full sf --version | awk '{print $1}')

          # ä¾‹: "salesforce-cli/2.77.6" ã‹ã‚‰æ•°å€¤éƒ¨åˆ†ã ã‘æŠœãå‡ºã™ (sedã§éæ•°å­—ã‚’é™¤å»)
          CLI_VERSION=$(echo "$CLI_VERSION_RAW" | sed -E 's/[^0-9.]//g')

          # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ä¿å­˜
          echo "CLI_VERSION=$CLI_VERSION" >> $GITHUB_ENV
          echo "ğŸš€ Salesforce CLI version detected: $CLI_VERSION"

      - name: Check if Image Exists on GHCR
        id: check-image
        run: |
          # ã™ã§ã« â€œCLI_VERSIONâ€ ã‚¿ã‚°ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å†ãƒ“ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
          IMAGE_TAG="${{ env.REPO_NAME }}:${{ env.CLI_VERSION }}"

          if docker manifest inspect $IMAGE_TAG > /dev/null 2>&1; then
            echo "âœ… Image already exists: $IMAGE_TAG"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
          else
            echo "âŒ Image does not exist: $IMAGE_TAG"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi

      - name: Delete Old Tags (Keep only latest)
        if: env.SKIP_BUILD == 'false'
        run: |
          echo "ğŸ”„ Checking for existing tags in GHCR..."

          # GHCR ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚°ä¸€è¦§ã‚’å–å¾— (curlã§APIå‘¼ã³å‡ºã—)
          TAGS_RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://ghcr.io/v2/${{ env.REPO_NAME }}/tags/list")

          echo "ğŸ“ GHCR API Response: $TAGS_RESPONSE"

          # jq ã§ â€œtagsâ€ key ã‚’é…åˆ—ã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã—ã€ã‚¿ã‚°åã‚’å–å¾—
          EXISTING_TAGS=$(echo "$TAGS_RESPONSE" | jq -r '.tags[]? // empty')

          # ã‚¿ã‚°ãŒã¾ã£ãŸãå­˜åœ¨ã—ãªã„å ´åˆ (åˆå›å®Ÿè¡Œæ™‚ãªã©) ã¯ã‚¹ã‚­ãƒƒãƒ—
          if [[ -z "$EXISTING_TAGS" ]]; then
            echo "ğŸš€ No existing tags found in GHCR. This is the first run. Skipping deletion."
            exit 0
          fi

          # å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¿ã‚°ã‚’å‰Šé™¤ (æœ€æ–°ã ã‘æ®‹ã™)
          for TAG in $EXISTING_TAGS; do
            if [ "$TAG" != "${{ env.CLI_VERSION }}" ]; then
              echo "ğŸ—‘ Deleting old image tag: $TAG"
              curl -X DELETE \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                "https://ghcr.io/v2/${{ env.REPO_NAME }}/manifests/$TAG"
            fi
          done

      - name: Normalize Salesforce CLI Version for Docker Tag
        run: |
          # å¿µã®ãŸã‚ CLIãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ­£è¦åŒ– (æ•°å­—ã¨ãƒ‰ãƒƒãƒˆã®ã¿ã«ã™ã‚‹)
          CLI_VERSION_RAW="${{ env.CLI_VERSION }}"
          CLI_VERSION=$(echo "$CLI_VERSION_RAW" | sed -E 's/[^0-9.]//g')

          echo "CLI_VERSION_NORMALIZED=$CLI_VERSION" >> $GITHUB_ENV
          echo "ğŸš€ Normalized CLI Version: $CLI_VERSION"

      - name: Build and Push Updated Image
        if: env.SKIP_BUILD == 'false'
        run: |
          IMAGE_TAG="${{ env.REPO_NAME }}:${{ env.CLI_VERSION_NORMALIZED }}"

          echo "ğŸ›  Building new image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .

          echo "ğŸ“¤ Pushing new image: $IMAGE_TAG"
          docker push $IMAGE_TAG

      - name: Output Status
        run: |
          if [ "${{ env.SKIP_BUILD }}" == "true" ]; then
            echo "â˜…â˜…â˜… No new Salesforce CLI version detected. Skipping build and push. â˜…â˜…â˜…"
          else
            echo "â˜…â˜…â˜… New Salesforce CLI version deployed: ${{ env.CLI_VERSION_NORMALIZED }} â˜…â˜…â˜…"
          fi
        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€çµ‚å‡ºåŠ›ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
