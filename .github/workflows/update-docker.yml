name: Update Salesforce Dev Container

# ãƒˆãƒªã‚¬ãƒ¼
on:
  schedule:
    - cron: '0 13 1 * *'  # æ¯æœˆ1æ—¥ã® 13:00 ã«å®Ÿè¡Œï¼ˆUTCåŸºæº–ï¼‰ï¼ˆæ—¥æœ¬æ™‚é–“4:00ï¼‰
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

# ã‚¸ãƒ§ãƒ–
jobs:
  update-docker:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # GitHub Container Registry ã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹æ¨©é™

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        # ç’°å¢ƒãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆDockerfile ãªã©ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ï¼‰

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        # GitHub Container Registry ã«ãƒ­ã‚°ã‚¤ãƒ³
        # `--password-stdin` ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã‚‹ã®ã‚’é˜²ã

      - name: Pull latest Salesforce CLI image
        run: docker pull salesforce/cli:latest-full
        # æœ€æ–°ã® Salesforce CLI ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆNode.js ã‚‚å«ã¾ã‚Œã‚‹ï¼‰

      - name: Get Salesforce CLI Version
        id: get-cli-version
        run: |
          CLI_VERSION=$(docker run --rm salesforce/cli:latest-full sf --version | awk '{print $1}')
          echo "CLI_VERSION=$CLI_VERSION" >> $GITHUB_ENV
          echo "â˜½â˜½â˜½ Salesforce CLI version detected: $CLI_VERSION"
        # `salesforce/cli:latest-full` ã‹ã‚‰ CLI ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã—ã€ç’°å¢ƒå¤‰æ•°ã«æ ¼ç´
        # `sf --version` ã®å‡ºåŠ›ã®æœ€åˆã®éƒ¨åˆ†ã‚’å–å¾—ã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã¨ã—ã¦ä½¿ç”¨

      - name: Check if Image Exists on GHCR
        id: check-image
        run: |
          IMAGE_TAG="ghcr.io/Yuta-Haruna/salesforce-docker-env:${{ env.CLI_VERSION }}"
          if docker manifest inspect $IMAGE_TAG > /dev/null 2>&1; then
            echo "Image already exists: $IMAGE_TAG"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
          else
            echo "Image does not exist: $IMAGE_TAG"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
          fi
        # GHCR ã«æ—¢ã«åŒã˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ç¢ºèª
        # ã™ã§ã«ã‚ã‚‹å ´åˆã¯ `SKIP_BUILD=true` ã«è¨­å®šã—ã€å†ãƒ“ãƒ«ãƒ‰ã‚’é˜²ã

      - name: Delete Old Tags (Keep only latest)
        if: env.SKIP_BUILD == 'false'
        run: |
          echo "ğŸ”„ Deleting old tags..."
          EXISTING_TAGS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://ghcr.io/v2/Yuta-Haruna/salesforce-docker-env/tags/list" | jq -r '.tags[]')

          for TAG in $EXISTING_TAGS; do
            if [ "$TAG" != "${{ env.CLI_VERSION }}" ]; then
              echo "ğŸ—‘ Deleting old image tag: $TAG"
              curl -X DELETE -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                "https://ghcr.io/v2/Yuta-Haruna/salesforce-docker-env/manifests/$TAG"
            fi
          done
        # GHCR ã«ã‚ã‚‹ã™ã¹ã¦ã®ã‚¿ã‚°ã‚’å–å¾—ã—ã€æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä»¥å¤–ã®ã‚¿ã‚°ã‚’å‰Šé™¤ã™ã‚‹
        # ã“ã‚Œã«ã‚ˆã‚Šã€ä¸è¦ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã‚’å‰Šæ¸›ã§ãã‚‹

      - name: Build and Push Updated Image
        if: env.SKIP_BUILD == 'false'
        run: |
          IMAGE_TAG="ghcr.io/Yuta-Haruna/salesforce-docker-env:${{ env.CLI_VERSION }}"
          
          echo "ğŸ›  Building new image: $IMAGE_TAG"
          docker build -t $IMAGE_TAG .
          
          echo "ğŸ“¤ Pushing new image: $IMAGE_TAG"
          docker push $IMAGE_TAG
        # `docker build` ã‚’å®Ÿè¡Œã—ã€æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œæˆï¼ˆã‚¿ã‚°ã¯ CLI ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
        # `docker push` ã§ GHCR ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰

      - name: Output Status
        run: |
          if [ "${{ env.SKIP_BUILD }}" == "true" ]; then
            echo "â˜…â˜…â˜… No new Salesforce CLI version detected. Skipping build and push. â˜…â˜…â˜…"
          else
            echo "â˜…â˜…â˜… New Salesforce CLI version deployed: ${{ env.CLI_VERSION }} â˜…â˜…â˜…"
          fi
        # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€çµ‚å‡ºåŠ›ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
